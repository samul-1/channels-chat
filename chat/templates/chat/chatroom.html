<!DOCTYPE html>
<html>
	<head>
		{% load static %}
		{% load auth_extras %}
		{# Load the tag library #}
		
		{% load bootstrap4 %}

		{# Load CSS and JavaScript #}
		{% bootstrap_css %}
		{% bootstrap_javascript jquery='full' %}
		<script src="{% static "chat/jquery-1.12.2.min.js" %}" type="text/javascript"></script>
		<script src="{% static "chat/reconnecting-websocket.min.js" %}" type="text/javascript"></script>

		<!-- Popvers -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
		
		<link rel="stylesheet" type="text/css" href="{% static 'chat/style.css' %}">
		<link rel="stylesheet" type="text/css" href="{% static colorset %}">
	</head>
	
	<body>
		<!--<div class="alert alert-primary" role="alert">-->
			<!-- <p>You are currently logged in as <b>{{ request.user.username }}</b> &mdash; <a href="/accounts/logout">Log out</a></p> -->
		<!--</div>-->
		<h3{% if invisible %} style="display:inline-block"{% endif %} id="chatroom_title">Chatroom</h3> 
		{% if invisible %}
			<span id="invisible_text" style="display:inline-block" class="text-muted"><em>(currently invisible)</em></span>	&nbsp;<button id="become_visible_but" class="btn btn-sm btn-dark" onclick="become_visible()">Become visible</button>
		{% endif %}
		<div id="chat_container">
			<div id="1" class="chatroom">
				{% for message in messages %}
					{% if message.in_room.pk == 1 %}
							{% if message.sent_by.pk == request.user.pk %}
								<span class="msg your_msg">
							{% else %}
								<span class="msg others_msg">
							{% endif %}
							{% if message.is_server_message == False %}
								{% if message.is_system_message == True %}
									<span class="sys_msg">
									{% if message.msg_text == " joined the chatroom" %}
										&nbsp;&rarr;
									{% endif %}
									{% if message.msg_text == " left the chatroom" %}
										&nbsp;&larr;
									{% endif %}
								{% endif %}
								{{ message.sent_by.username }}{% if message.is_system_message == False %}:{% endif %}
							{% endif %}
							{% if message.is_server_message == True %}
								<b class="server">Server message: </b>
							{% endif %} 
							{{ message.msg_text }} 
							{% if message.is_system_message == True %}
									</span>
							{% endif %}
							<i class="timestamp">
							{% if message.timestamp.date < today %}
								{{ message.timestamp|date:"m/d/Y" }}
							{% endif %}
							{{ message.timestamp|time:"H:i" }}
							</i>
							</span>
						{% endif %}
				{% endfor %}
				<span class="msg your_msg">&nbsp;&rarr; {{ user }} joined the chatroom</span>
			</div>
			{% for room in rooms %}
				<div id="{{ room.pk }}" class="chatroom">
					{% for message in messages %}
					{% if message.in_room.pk == room.pk %}
							{% if message.sent_by.pk == request.user.pk %}
								<span class="msg your_msg">
							{% else %}
								<span class="msg others_msg">
							{% endif %}
							{% if message.is_server_message == False %}
								{% if message.is_system_message == True %}
									<span class="sys_msg">
									{% if message.msg_text == " joined the chatroom" %}
										&nbsp;&rarr;
									{% endif %}
									{% if message.msg_text == " left the chatroom" %}
										&nbsp;&larr;
									{% endif %}
								{% endif %}
								{{ message.sent_by.username }}{% if message.is_system_message == False %}:{% endif %}
							{% endif %}
							{% if message.is_server_message == True %}
								<b class="server">Server message: </b>
							{% endif %} 
							{{ message.msg_text }} 
							{% if message.is_system_message == True %}
									</span>
							{% endif %}
							<i class="timestamp">
							{% if message.timestamp.date < today %}
								{{ message.timestamp|date:"m/d/Y" }}
							{% endif %}
							{{ message.timestamp|time:"H:i" }}
							</i>
							</span>
						{% endif %}
				{% endfor %}
				</div>
			{% endfor %}
		</div>
		<div id="online_users" class="sidebar shadow-sm">
			<span class="heading">Online users:</span>
			{% for user in online_users %}
				<p class="online_user {% if invisible and user.of_user == request.user %}text-muted semi-transparent{% endif %}" id="{{ user }}">
					{{ user }}
					{% if request.user|has_group:"Operator" %} 
						<button class="btn btn-sm kick-btn btn-danger" onclick="kickUser('{{ user }}')"><i class="fas fa-user-minus"></i></button>
						<button class="btn btn-sm kick-btn btn-danger" data-toggle="modal" data-target="#banModal" onclick="ban_target = '{{ user }}'"><i class="fas fa-user-times"></i></button>
					{% endif %}
					{% if user.of_user.username != request.user.username %}
						<!-- <button class="btn btn-sm msg-btn btn-primary priv_msg_but popup" onclick="fadeInDialog('{{ user }}')"><i class="fas fa-envelope"></i></button>
						<div class="card text-center popuptext shadow-sm" id="{{ user }}_dialog">
							<div class="card-header"><span class="card-title">Send message to {{ user }}:</span></div>
							<div class="card-body"><textarea style="width: 12rem" id="msg_input_{{ user}}"></textarea><br />
							<button class="btn btn-primary" id="msg_{{ user }}" onclick="sendPrivateMessage(this.id, '{{ user }}')">Send</button></div>
						</div> -->
						<button class="btn btn-sm msg-btn btn-primary priv_msg_but popup" id="{{ user }}_dialog" data-html="true" data-toggle="popover" data-placement="bottom" title="Send message to {{ user }}" data-content='<div><center><textarea style="width: 12rem" id="msg_input_{{ user}}"></textarea><br />
							<button class="btn btn-primary" id="msg_{{ user }}" onclick="sendPrivateMessage(this.id, &apos;{{ user }}&apos;)">Send</button></center></div>'><i class="fas fa-envelope"></i>
						</button>
					{% endif %}
				</p>
			{% endfor %}
		</div>
		<br />
		<div class="tabs-nav-wrap sidebar shadow-sm">
			<span class="heading">Conversations:</span>
			<ul class="tabs-nav" id="convo_list">
				<li class="tab-nav-link" id="nav_1" data-target="#1">Chat</li>
				{% for room in rooms %}
					<li id="nav_{{ room.pk }}" class="tab-nav-link" data-target="#{{ room.pk }}">{{ room.title }}</li>
				{% endfor %}
			 </ul>
		   <div style="clear:both;"></div>
		</div><!-- ends tabs-nav-wrap -->	 
		<div id="colorset_form" class="sidebar" style="border: 0">
			<form action="set_theme" method="post">
				{% csrf_token %}
				{{ colorform.as_table }}
			</form><br />
		</div>
		<br />
		<div id="message_input">
			<div class="input-group mb-3">
				<div class="input-group-prepend">
				  <span class="input-group-text" id="inputGroup-sizing-default">{{ request.user }}</span>
				</div>
				<input autocomplete="off" type="text" name="msg_text" size="98" id="message-input" required="">
				<div class="input-group-append">
					<span class="input-group-text"  style="margin-right: 5px">
						<button class="btn btn-sm" id="attachment_but" data-html="true" data-toggle="popover" data-placement="bottom" title="Upload a file" data-content='
						<div style="position: relative" class="text-center">
							<div id="cooldown" style="position: absolute; display: none; z-index: 9"></div>
							<form id="attachment_form" enctype="multipart/form-data" action="" method="post">
							{% csrf_token %}
							{{ attachment_form.as_table }} <hr />
							<input class="btn btn-primary" type="submit" value="Upload" />
						</form></div>'><i class="fas fa-paperclip"></i>
						</button>
						<!-- <form id="attachment_form" enctype="multipart/form-data" action="" method="post">
							{% csrf_token %}
							{{ attachment_form.as_table }}
							<input type="submit" value="Upload" />
						</form> -->
					</span>
				</div>
				<button class="btn btn-dark" id="submit-button"><i class="fas fa-paper-plane"></i>&nbsp; Send&nbsp;</button> &nbsp;
				<a href="/accounts/logout" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Log out</a>
				<br />
			</div>
		</div>
		{% if invisible %}
			<center><div id="invisible_warning" style="clear: both; width: 60%" class="alert alert-danger" role="alert">
				You are currently in invisible mode. If you send a message to the chatroom, other users will still be able to see it. Click <b>Become visible</b> to disable invisible mode and enter the chat normally.
			</div></center>
		{% endif %}
		<br />
  
		{% if request.user|has_group:"Operator" %} 
			<!-- Modal -->
			<div class="modal fade" id="banModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="exampleModalLabel">Confirm operation</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">
							Are you sure you want to ban this user?
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
							<button type="button" onclick="banUser(ban_target)" data-dismiss="modal" class="btn btn-primary">Yes</button>
						</div>
					</div>
				</div>
			</div>
		{% endif %}
		  
		  <script>
			$(document).ready(function() {
				initializePopovers()
			});

			function initializePopovers() {
				$("[data-toggle=popover]").popover({
				html: true, 
				delay: 100,
				sanitize: false,
				template: '<div class="popover shadow" role="tooltip"><div class="arrow"></div><h3 class="dialog popover-header"></h3><div class="dialog popover-body"></div></div>',
				content: function() {
					return $('#popover-body').html();
					}
				});

				$("[data-toggle=popover]").on('click', function (e) {
					$("[data-toggle=popover]").not(this).popover('hide');
				});

			}
			function toggleDialog(user) {
				$('#' + user + '_dialog').popover('hide')
  			}
		  </script>
		
		<script>
			const this_user = "{{ request.user.username }}"
			const this_user_is_op
			{% if request.user|has_group:"Operator" %} 
				 = true
			{% else %} 
				 = false
			{% endif %}
			const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/')
			chatSocket.onopen = function () {
  				chatSocket.send(
    				JSON.stringify({
      				command: 'join',
      				room: '1',
      				invisible: {% if invisible %}'1'{% else %}'0'{% endif %},
    			})
  				)
			}
		</script>
		<script type="text/javascript" src="{% static 'chat/ui.js' %}"></script>
		<script type="text/javascript" src="{% static 'chat/chat_frontend.js' %}"></script>
		<script type="text/javascript" src="{% static 'chat/script.js' %}"></script>
		<script type="text/javascript" src="{% static 'chat/attachments.js' %}"></script>
		<script src="https://kit.fontawesome.com/c4a4310769.js" crossorigin="anonymous"></script>
	</body>
</html>
